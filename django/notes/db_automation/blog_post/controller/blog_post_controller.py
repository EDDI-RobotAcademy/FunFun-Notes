import uuid

from django.db import transaction
from django.http import JsonResponse
from django.shortcuts import render
from rest_framework import viewsets, status
from rest_framework.status import HTTP_200_OK

from blog_post.service.blog_post_service_impl import BlogPostServiceImpl
from redis_cache.service.redis_cache_service_impl import RedisCacheServiceImpl


class BlogPostController(viewsets.ViewSet):
    blogPostService = BlogPostServiceImpl.getInstance()
    redisCacheService = RedisCacheServiceImpl.getInstance()

    def requestBlogPostList(self, request):
        getRequest = request.GET
        page = int(getRequest.get("page", 1))
        perPage = int(getRequest.get("perPage", 8))
        paginatedBlogPostList, totalItems, totalPages = self.blogPostService.requestList(page, perPage)

        # JSON ì‘ë‹µ ìƒì„±
        return JsonResponse({
            "dataList": paginatedBlogPostList,  # ê²Œì‹œê¸€ ì •ë³´ ëª©ë¡
            "totalItems": totalItems,  # ì „ì²´ ê²Œì‹œê¸€ ìˆ˜
            "totalPages": totalPages  # ì „ì²´ í˜ì´ì§€ ìˆ˜
        }, status=status.HTTP_200_OK)

    def requestCreateBlogPost(self, request):
        postRequest = request.data
        print("ğŸ“¥ ë°›ì€ ë°ì´í„°:", postRequest)

        title = postRequest.get("title")
        content = postRequest.get("content")
        userToken = postRequest.get("userToken")

        if not userToken:  # userTokenì´ ì—†ê±°ë‚˜ ë¹ˆ ë¬¸ìì—´ì´ë©´ 400 ë°˜í™˜
            return JsonResponse(
                {"error": "User token is required."},
                status=status.HTTP_400_BAD_REQUEST
            )

        accountId = self.redisCacheService.getValueByKey(userToken)
        print(f'requestCreateBlogPost() accountId: ${accountId}')

        if not accountId:  # userTokenì´ ìœ íš¨í•˜ì§€ ì•Šì€ ê²½ìš°ë„ ê±°ë¶€
            return JsonResponse(
                {"error": "Invalid user token."},
                status=status.HTTP_401_UNAUTHORIZED
            )

        savedBlogPost = self.blogPostService.requestCreate(title, content, accountId)

        return JsonResponse({"data": savedBlogPost}, status=status.HTTP_200_OK)
